# 2장 네트워크 서비스와 애플리케이션 계층

애플리케이션 계층의 프로토콜이 하는 일은 특정 서비스를 제공하기 위해 서버와 클라이언트 사이에서 다양한 메시지나 명령을 주고 받는 것이다. 애플리케이션 계층은 사용자에게 직접 노출되는 부분이기 때문에 상대적으로 다른 계층보다 더 중요한 계층으로 보이게 된다. 하지만 애플리케이션 계층이 서비스 제공에 집중할 수 있는 것은 트랜스포트 계층을 포함한 하위 계층에서 데이터 전송을 잘 처리해주고 있기 때문이다.
통신이 제대로 이루어지기 위해서는 네트워크 계층 모델중 어느 한 계층도 빠져서는 안되며, 이들 계층의 역할이 모두 중요하다.
애플리케이션 계층은 사용자가 직접 사용하면서 체감할 수 있는 서비스를 제공한다. 네트워크 계층 모델중 트랜스포트 이하의 계층들은 데이터 전송을 담당하고 있으므로 이들 데이터 전송 관련 계층을 제외한 모든 영역이 애플리케이션 계층의 범주라고 보면 된다.
인터넷을 사용하는 서비스중 가장 대표적인 WWW(World Wide Web)은 HTTP라는 프로토콜을 사용한다.
웹브라우저가 웹서버로 특정 웹페이지를 요청하면 웹 서버가 해당 페이지의 내용을 HTML형식으로 응답한다.웹 브라우저는 이 데이터를 해석하여 웹 페이지 화면을 그린후 사용자에게 보여준다. URL로 페이지를 요청하면 파일로 응답을 돌려주는 간단한 동작 방식이다. HTTP메시지는 request line, status line, header, blank line, message body로 구성된다.
HTTP는 통신시 정보를 한 번씩 주고 받은후 바로 끊는 형태로 처리된다. 이렇게 상태 정보를 저장하지 않는 통신형태를 스테이트리스(stateless)라고 한다. HTTP는 대표적인 무상태 프로토콜이다.(HTTP는 상태가 없다. stateless) 웹 서비스에서는 상태 정보 유지를 위한 별도의 처리가 필요하다.
특정 웹페이지를 받아보기 위해서는 HTTP요청을 보내야하는데 이때 URL(Uniform Resource Locator) 이라는 문자열을 사용한다.
GET요청인 경우 별도의 요청 내용인 메시지 바디가 없다.
웹 서비스나 웹 어플리케이션은 웹의 동작 방식을 응용하여 사용자와 상호작용하기 위해 만들어진 프로그램이다. 웹 서비스를 요청하면 웹 서버가 결과를 미리 만들어 놓지 않고 서버 프로그램이 HTML 데이터를 동적으로 만들어서 응답한다. 웹 페이지와 웹 서비스의 차이는 미리 만들어둔 정적인 HTML파일로 응답하느냐, 아니면 서버 프로그램이 요청 내용에 따라 동적으로 HTML데이터를 만들어 응답을 하느냐의 차이이다.
웹 서버에서 동작하는 프로그램을 서버사이드 프로그램 혹은 서버측 프로그램이라고 한다. 서버측 프로그램은 HTTP메시지를 주고받는다는 조건만 맞으면 구현 방법은 어떤 것이라도 상관 없기 때문에, Perl, PHP, Python, Ruby등의 다양한 언어로 개발된다. 웹 초장기에는 웹서버에서 이들 서버측 프로그램을 실행하기 위해 CGI(Common GateWay Interface)라는 방식을 사용했었다. 이후에는 CGI보다 응답 속도가 우수한 웹서버 추가 모듈 형태로 동작하는 방식이 바뀌었다. 최근의 웹 서비스는 시스템의 사용성을 높이기 위해서 AJAX(Asynchronous js and xml)이라는 기술을 적용한다. AJAX는 HTTP메시지로 통신한다는 점에서 일반적인 요청 방식과 비슷하지만, 요청을 보내는 주체가 브라우저가 아닌 자바스크립트라는것에 차이가 있다. 즉 AJAX는 웹 브라우저가 웹 서버로 요청하는 것이 아니라, 자바스크립트로 작성된 프로그램이 웹 서버와 통신한다. 그리고 응답 결과로 받은 내용에 대해서는 웹 브라우저가 전체 페이지를 다시 그려 화면을 갱신하는 방식이 아니라, 자바스크립트가 웹 페이지 특정 부분에만 응답 받은 내용이 갱신되도록 처리한다. 결과적으로 사용자는 전체페이지를 다시 조회하지 않아도 되고, 서버의 응답을 바로 받아 상호작용할 수 있으므로 보다 자연스러운 서비스 이용과 보다 향상된 사용자 경험을 느낄 수 있다.

## 세션을 유지하기 위한 쿠키

HTTP는 무상태 프로토콜이기 때문에 요청과 응답을 한번씩 주고받은 후에 통신이 끊어진다. 그래서 온라인 쇼핑몰에서 상품을 선택하고 구입 결정을 한 후에 결제 화면으로 이동하는 것처럼 여러단계의 흐름 처리를 할 때는 각 요청이 동일한 사용자가 보낸 것인지 다른 사용자가 보낸 것인지 판단하지 못한다. 이런 경우 여러 건의 요청 처리를 동일한 사용자 접속 세션으로 인식 할 수 있도록 쿠키를 사용한다. HTTP는 기본적으로 요청과 응답하는 과정에서 상태 정보를 저장하지 않아 무상태 혹은 스테이트리스 프로토콜이라고 하며, 상태를 유지하면서 연속된 응답을 해야 할 때는 쿠키라는 기술을 사용한다.
웹 브라우저는 응답받은 메시제에 'Set-Cookie'라는 문자열이 있는지 확인하고 , 만약 있으면 그 내용을 로컬 디스크에 쿠키 형태로 저장한다. 쿠키 정보는 악용될 경우 보안 문제가 발생할 수 있기 때문에 이에 대비한 조치가 필요한데, 기본적으로 웹브라우저가 이에 대한 방어책을 자체적으로 구현하고 있다. 예를 들면, 쿠키가 생성된 웹서버와 동일한 도메인을 사용하는 웹사이트에서만 쿠키가 전송되도록 제한하거나, 이미 저장된 쿠키들이 있다면 유효기간을 확인하고 유효기간이 지난 것은 자동으로 폐기하기도 한다.
유출되었을 때 보안 문제가 생길 만한 정보는 클라이언트 PC의 쿠키에 저장하지 말아야한다. 기본적으로 각종 정보는 서버 쪽에 저장하는 것이 원칙이고, 동일한 사용자인지 확인하기 위한 세션ID등의 식별 정보만 클라이언트 쿠키에 저장하도록 제한해야한다.

## 이메일

송신과 수신에 서로 다른 프로토콜을 사용한다.
이메일에서 사용되는 애플리케이션 계층 프로토콜에는 발신할 때 사용하는 SMTP(Simple Mail Transfer Protocol)와 수신할 때 사용하는 POP(Post Office Protocol)가 있다. 그래서 메일 발신자는 SMTP를 사용하여 수신자의 메일 서버로 메일을 보내고 메일 수신자는 POP를 사용해서 메일 서버로부터 자신의 메일을 받는다.
SMTP 프로토콜은 클라이언트 PC가 메일 서버로 메일을 보낼 때만 사용되는 것이아니라, 발신자의 메일 서버에서 수신자의 메일 서버로 메일을 중계할 때도 사용된다. HTTP프로토콜과는 달리 상태를 가지는 스테이트풀 프로토콜이기 때문에 전송 종료 명령이 보내저야 통신을 종료한다.
SMTP프로토콜을 사용해서 전송된 메일은 최종적으로 수신자의 메일 서버에 저장된다. 이후 메일 서버에 저장된 메일을 확인할 때는 POP프로토콜을 사용한다. 메일을 수신하는 것 외에도 수신한 메일 건수나 용량확인, 메일 삭제와 같은 처리에도 POP프로토콜을 사용한다. POP에는 몇가지 버전이 있는데 현재 사용하는 것은 POP3버전이다. 다른 프로토콜들은 버전을 명시하지 않는 경우가 많은데, 굳이 버전을 명시하는 이유는 POP프로토콜이 하위 버전과 차이가 너무 커서 다른 버전과 혼용될 경우 오작동이 발생할 수 있기 때문이다.
STMP에는 POP와 같은 사용자 인증 체계가 없기 때문에 스팸메일 발송등에 종종 악용되기도 한다. 그래서 POP서버의 인증 기능을 활용하거나 다른 네트워크로부터 SMTP 접근을 제한하는 대안을 사용하기도 한다. 그 외에도 SMTP Auth프로토콜이라는 것이 만들어졌는데, 이는 SMTP에 사용자 인증 기능이 추가된 확장 프로토콜이다.
POP프로토콜은 기본적으로 클라이언트가 메일을 수신하면 메일 서버에 보관된 메일을 삭제하게 되어있다. 그래서 메일을 오랫동안 보관하려면 클라이언트 PC에 메일을 오랫동안 보관하려면 클라이언트 PC에 메일을 보관할 저장공간을 확보해 두어야 한다. 이에 반해 IMAP프로토콜은 클라이언트 PC가 메일을 수신하더라도 메일 서버에서 수신한 메일을 지우지 않고 보관하게 되어있다. 이런 방식은 메일 저장공간이 충분하지 않은 스마트폰 등의 휴대기기에서 많이 활용된다.

## PC끼리 파일 공유하기

파일 공유는 개인 컴퓨터에 공유 디렉터리를 만든후 , 그안에 공유할 파일을 저장하여 여러 사람이 함께 활용할 수 있도록 만드는 서비스다.
개인컴퓨터에서 많이 사용되는 파일 공유는 공유에 참여하는 각각의 컴퓨터가 서로 서버가 되기도하고 클라이언트가 되기도 하는 피어 투 피어(P2P, peer to peer)방식을 사용한다. 특별히 공유를 위한 서버를 별도로 준비할 필요가 없고 공유할 컴퓨터끼리 네트워크에 접속하기만 하면 된다. 그 위에도 NAS(Network Attached Storage) 라는 파일 공유 프로토콜을 지원하는 전용 컴퓨터가 있는데, 다른 개인 컴퓨터들과 같이 네트워크에 연결하기만 하면 쉽게 공유에 참여할 수 있다. 파일 공유는 피어투피어 방식이기 때문에 중앙에서 관리하는 서버가 없다. 처음에는 LAN에 연결된 컴퓨터들 중 어떤 컴퓨터가 공유를 하고 있는지 알 방법이 없기 때문에 일단 컴퓨터가 네트워크에 연결되면 다른 모든 컴퓨터에게 자신이 연결되었다는 것을 통보하게 된다. 이때 통보를 받은 다른 컴퓨터는 자신의 정보를 응답으로 알려주게 되고, 결과적으로 네트워크 전체에서 공유가능한 컴퓨터들을 서로 식별할 수 있게된다.
파일 공유기능은 OS에 기본적으로 탑재되어있는데, 윈도우에서는 SMB(Server Message Block) 이 사용되고 맥 OS X에서는 AFP(Apple Filing Protocol)가 사용되는 등 OS마다 독자적인 파일 공유 프로토콜을 제공한다. 다만, 최근에는 다른 OS의 프로토콜도 지원할 수 있게되어 간단한 설정만으로 파일을 서로 공유할수 있게 되었다.

## 파일을 전송하는 FTP

FTP는 네트워크에 연결된 서버로 파일을 전송하기 위한 프로토콜이다.
LAN에서는 파일 공유와 같은 더 간단한 파일 전송 방법이 있기 때문에 주로 인터넷에 연결된 서버에 파일을 전송할 때 사용한다. 명령어를 사용해서 파일을 업로드하거나 다운로드하고 디렉터리를 만들거나 파일을 삭제하기도 한다. FTP는 웹서버로 웹페이지를 전송할때 자주 사용된다. 한대의 서버에서FTP서버 프로그램과 웹서버 프로그램을 함께 구동하고 있다면 , FTP로 HTML파일을 전송하고 이 파일을 웹서버가 HTTP를 통해 서비스하는 것이 가능하다. FTP에서는 크게 파일을 주고받기 위한 데이터 커넥션과 명령어를 보내기위한 컨트롤 커넥션의 두가지 접속 형태를 사용한다. 이렇게 접속형태가 분리되어 있으면 파일 전송 중에도 명령을 줄 수 있어서 전송중인 파일을 중단시키는 것이 가능하다.
방화벽이나 가정용 초고속 인터넷 라우터를 사용하는 경우 외부와의 통신을 차단하는 경우가 많다. 특히 FTP 서비스에는 서버 내부에서 외부로 나가는 통신을 방화벽이 차단하여 파일 전송이 안되는 경우가 발생하기도 하는데, 이때는 패시브 모드를 사용해서 클라이언트쪽에서 서버 쪽으로 역방향으로 데이터 커넥션을 만들어 주면 파일을 전송할 수 있게 된다.

## 원격지의 컴퓨터 제어하기

원격지의 컴퓨터를 제어하는 방법으로는 CLI(Command Line Interface)와 같은 명령 프롬프트를 통해 명령어로 제어하는 방법과 GUI를 통해 제어하는 방법이있다.
Telnet 이나 SSH(Secure Shell)은 원격지의 컴퓨터를 명령으로 제어하기 위한 프로토콜이다. 서버들은 데이터 센터와 같이 먼곳에 설치되어 있는 경우가 많기 때문에 서버를 관리할 때는 Telnet이나 SSH를 사용하는 것이 일반적이다. Telnet이나 SSH는 윈도우의 명령프롬프트에서 명령을 내리면 그 내용을 그대로 서버로 전달하는데 명령에 대한 결과가 다시 텍스트로 표시되어 마치 서버앞에 앉아 있는 것처럼 작업 할 수 있다. 최근에는 보안을 위해 통신 내용이 암호화되어있는 SSH를 많이 사용한다.
원격 제어를 할 때 텍스트 형태의 명령어 방식외에도 GUI인터페이스를 사용한 도구나 원격제어관련 프로토콜을 활용하는 방식이 있다. 윈도우에 내장된 원격 데스크톱은 RDP(Remote Desktop Protocol)프로토콜을 사용하고, OS에 독립되어 범용으로 사용 가능한 VNC(Virtual Network Computing)는 RFB(Remote FrameBuffer)프로토콜을 사용한다. GUI인터페이스를 사용할 때는 마우스나 키보드의 제어 정보를 서버로 보낸 후에 원격 서버의 화면 이미지를 응답으로 받는 방식이기 때문에 화면이미지의 데이터 크기를 줄여주기 위한 압축 기술도 함께 사용된다. 한때 원격 데스크톱이나 VNC를 응용한 예로 가상 OS와 씬 클라이언트를 조합한 서비스가 있었다. 이 방식은 한대의 서버 컴퓨터에 여러대의 가상 OS를 운영하고 저사양 PC에서 서버의 가상 OS로 원격 데스크톱이나 VNC로 접속하는 방식으로 서버자원을 원격 제어를 통해 사용하는 것이 가능했다.

## VOIP 와 영상 스트리밍

인터넷에서 음성이나 동영상을 보낼 때에는 데이터를 압축하거나 분할해서 보낸다.
요즘에는 과거와는 달리 컴퓨터에서 음성이나 동영상을 주고받는 것은 어렵지 않은 기술이 되었고, 일상생활에서도 많이 활용될 만큼 보편적인 서비스가 되었다. 인터넷 전화서비스로는 스카이프나 라인등이 대표적이고, 스마트폰에서는 LTE와 함께 VoIP(Voice over IP)기술이 사용되기도 한다. 음성이나 동영상 데이터는 메일과 같은 텍스트 형태의 정보에 비해 상대적으로 데이터 용량이 크기 때문에 통신의 신뢰성보다는 전송 속도를 우선하는 UDP를 사용하고 전송시에는 데이터를 압축하되 수신된 정보를 바로 재생할 수 있는 스트리밍 기술을 사용한다.송신하는 쪽에서는 녹음하면서 바로 전송하고, 수신하는 쪽은 마지막까지 수신된 것을 기다리지 않고 데이터가 들어오는 대로 바로 재생한다. 전송 중에 일부 데이터가 누락되더라도 신경 쓰지 않는다. 음성이나 동영상을 주고받는 서비스는 중간에 서버를 경유하지 않고, 컴퓨터나 스마트폰끼리 직접 통신하는 피어투피어방식을 사용하는 것이 일반적이다.다만 피어 투 피어 방식은 서로 통신할 상대를 찾는 것이 어렵기 때문에 우선 클라이언트 서버 방식으로 디렉터리 서버에 접속하여 상대를 찾은 다음, 상대방과 통화할때 피어투 피어 방식으로 직접 통신하는 하이브리드 방식도 많이 활용된다.
음성이나 동영상 처리하는 프로토콜은 아직 널리 보편화된 것은 아니기 때문에 일부 네트워크 환경에서는 통신이 거부되는 경우가 종종 발생할 수 있다. 그래서 유튜브와같은 동영상 공유 서비스에서는 동영상 프로토콜에서 사용할 데이터를 HTTP메시지 안에 채워 넣는 기술을 사용하고 있다.HTTP라면 차단되는 경우가 거의 없으므로 더많은 환경에서 차단 없이 동영상을 서비스 할 수 있다.

## MIME

이메일은 메일의 주 내용인 텍스트 데이터 외에도 파일을 첨부하거나 HTML형식의 메일에 서식을 입히는 것이 가능하다. 이렇게 텍스트 외의 데이터를 추가하기 위해 만든 것이 MIME(Multipurpose Internet Mail Extensions)이다. 원래 이메일에 포함할 수 있는 데이터는 영문이나 숫자로 표현되는 7비트 US-ASCII 형식이다. 그래서 첨부 파일과 같으 데이터는 MIME를 이용해서 영문과 숫자의 조합으로 변환하여 메일 본문안에 포함시키면, 마치 텍스트 데이터인 것처럼 처리한다. 한글로 작성된 메일은 7비트 US-ASCII로 표현을 할 수 없기 때문에 같은 방법으로 MIME을 활용하고 있다. Content-type 뒤에 데이터 종류를 표현하는 문자열을 MIME타입이라고 하는데, HTTP에서도 웹 페이지 데이터를 주고 받을 때 MIME타입 정보를 활용한다.

## 네트워크 오류를 통보하는 ICMP

데이터 전송중에 오류가 발생하면 ICMP프로토콜로 통보한다.
ICMP(Internet Control Message Protocol)프로토콜은 데이터 전송중에 문제가 생길 경우 장애 상황을 통보하기 위해 사용된다. 예를 들어서 수신측 컴퓨터가 전원이 꺼져있어 데이터가 전달되지 못한다면 송신측으로 3번 ICMP메시지가 전달된다. 송신측은 이 메시지를 보고 데이터가 수신측까지 전달되지 않았다는 것을 파악하고 적절한 처리를 하게 된다.
타입
0 에코응답, 수신측 장비가 존재한다고 확인할 때 사용한다.
3 데이터가 도착하지 않았다.
4 회선 상태가 복잡하다.
5 경로 상태가 최적이 아니다.
8 에코 요청. 수신측 장비가 존재하는지 확인할 때 사용한다.
9 라우터가 보내는 응답으로, 네트워크에 새로 연결된 장비에게 사용가능한 라우터 정보를 알려주기 위해 사용한다.
10 장비가 보내는 요청으로 네트워크에 새로 연결 되었을 때 라우터를 찾기 위해 사용한다.
11 생존 기간이 지난 패킷을 삭제했음을 알려준다.
ICMP패킷은 IP헤더에 타입이나 코드와 같은 ICMP메시지를덧붙인 형태이다.
목적지에 도달하기 전에 패킷의 생존기간이 경과하게 되면 이 패킷은 네트워크상에서 소멸되는데, 이때 라우터가 패킷을 보낸 송신측으로 타입 11번 ICMP메시지를 보내게 된다.한편 네트워크에 속한 라우터의 IP어드레스를 알고 싶을 때는 타입 10번과 타입 9번 ICMP메시지를 사용하면 된다.

## 어드레스 변환

프라이빗 IP어드레스를 할당받은 호스트와 퍼블릭 IP어드레스를 할당받은 호스트는 기본적으로 서로 통신을 하지 못한다. 하지만 어드레스 변환 기술을 사용하면 둘 간 통신이 가능해진다.
가정이나 사무실의 네트워크에서는 보통 프라이빗 IP어드레스를 사용한다. 이 주소는 내부에서 사용하는 가상의 주소라서 인터넷에 연결된 퍼블릭 IP어드레스를 사용하는 서버와의 통신은 불가능하다. 그래서 이때 네트워크 어드레스 변환 (NAT, Network Address Translation) 기술이 사용된다. NAT기술은 프라이빗 IP어드레스와 퍼블릭 간의 변환외에도IPv4와 IPv6간의 변환에도 응용된다.
송신할때 송신지의 프라이빗 아이피 어드레스를 라우터의 퍼블릭IP어드레스로 바꿔서 데이터를 보낸다.
수신할때는 기억해둔 송신지 주소로 데이터를 보낸다(라우터) 수신할때 라우터의 퍼블릭 IP어드레스를 송신지의 프라이빗 IP어드레스로 바꿔보낸다.
NAT은 단순히 IP어드레스를 변환할 뿐이다. 그래서 몇가지 상황에서는 제약이 발생할 수 있다. 우선, 내부의 여러 호스트가 공교롭게 같은 포트를 사용하고 있다면 라우터는 이 요청에 대한 응답을 어느 호스트에게 되돌려 보내야 하는지 포트만 보고는 판단하지 못한다. 또 내부에서 보낸 요청에 대한 응답은 받을 수 있지만 외부에서 일방적으로 보낸 데이터는 NAT범위 안에 있는 호스트로 전달되지 않는다. 포트번호를 같게 요청보내면 퍼블릭 IP로 바뀔때 프라이빗IP는 취급되지않으므로 서버에서 수신받을 때 같은 요청이 발생한 것으로 인식해버린다.
NAT의 포트 번호 충돌을 막기 위해 만들어진 방식이 네트워크 어드레스 포트 변환(NAPT Network Address Port Translation)이다. 이 방식은 IP어드레스뿐만아니라 포트 번호도 함꼐 변환한다. 내부 네트워크에서 프라이빗 IP를 사용하는 여러 호스트가 같은 포트 번호를 사용하고 있다면, 외부와 통신할 때 포트 번호가 충돌나지 않도록 변환해서 요청을 보낸 호스트를 구분할 수 있도록 한다.
SNS등에서는 자동으로 메시지 도착 알림이 되는데, 이러한 서비스는 대부분 내부에서 메시지 도착 여부를 정기적으로 확인 요청하는 방법으로 구현된다. 사용자가 직접요청한 것은 아니지만 내부에서 외부로 자동으로 정보를 요청하고 응답을 받는 방식이라서 라우터가 데이터를 전달하는데 큰 문제가 없다.
LAN안에 웹서버나 FTP서버를 운영하면서 외부로 이 서비스를 공개 해야 할 때가 있다. 이때 라우터의 특정 포트 번호로 통신이 들어오면 내부의 특정 서버에 전달되도록 설정할 수 있는데, 이방법을 포트 포워딩(Port Forwarding)이라고 한다.
